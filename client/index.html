<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="stylesheet" type="text/css" media="screen" href="style.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <title>SuperDuperHyperMarket</title>
    </head>
    <body>
        <script>
            window.fbAsyncInit = function() {
                FB.init({
                    appId            : 1370404409760808,
                    autoLogAppEvents : true,
                    xfbml            : true,
                    version          : 'v3.1'
                });
            };
        
            (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>
        <div class="container-fluid bg-white fixed-top">
            <div class="row">
                <div class="col-sm-12 col-md-10 text-center text-md-left my-sm-2" style="font-size: 30px; padding-left: 2.5vw">SuperDuperHyperMarket</div>
                <div class="col-sm-12 col-md-2 align-self-center text-center my-sm-2">
                    <a class="mx-3 logoInHead" data-toggle="modal" data-backdrop="false" data-target="#logModal" href="#"><i class="fas fa-sign-in-alt" style="font-size: 30px"></i></a>
                    <a id='cartLogo' class="mx-3 logoInHead" data-toggle="modal" data-backdrop="false" data-target="#cartModal" title="Cart" href="#app1"><i class="fas fa-shopping-cart" style="font-size: 30px"></i></a>
                    
                    <!-- LOG MODAL -->
                    <div class="modal fade" id="logModal" tabindex="-1" role="dialog" aria-labelledby="logModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div id='app4'>
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="logModalLabel">{{ title }}</h5>
                                    </div>
                                    <div class="modal-body">
                                        <div class="isLogOut">
                                            <input id='email' type="email" value="" placeholder="Email"><br><br>
                                            <input id='password' type="password" value="" placeholder="Password"><br>
                                            <div style="color: red">{{ notice }}</div><br>
                                            <button class="btn btn-danger" onclick="logIn()">Log In</button><br><br>
                                            <button class="btn btn-danger" onclick="register()">Register</button><br><br>
                                            or<br><br>
                                            <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button><br>
                                        </div>
                                        <div class="isLogIn">
                                            <button class="btn btn-danger" onclick="logOut()" data-dismiss="modal">Log Out</button><br><br>
                                        </div>
                                    </div>
                                    <div class="modal-footer align-self-center">
                                        <button id='logLaterBtn' type="button" class="modalBtn" data-dismiss="modal">Later</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CART MODAL -->
                    <div class="modal fade" id="cartModal" tabindex="-1" role="dialog" aria-labelledby="cartModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div id="app3" class='align-self-center'>
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="cartModalLabel">Cart</h5>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-4" v-for="item in cart">
                                            <div class="col-5">
                                                <div class="row">
                                                    <div class="col-12 text-left"><strong>{{ item.name }}</strong></div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12 text-left">{{ item.count }}xRp{{ item.price }}</div>
                                                </div>
                                            </div>
                                            <div class="col-5">
                                                <div class="row">
                                                    <div class="col-12" style="visibility: hidden">placeholder</div>
                                                    <div class="col-12 text-right"><strong>{{ item.total }}</strong></div>
                                                </div>
                                            </div>
                                            <div class="col-2">
                                                <button class="btn btn-danger" title="Remove from cart" v-on:click="removeFromCart(item.name, item.price)">-</button>
                                            </div>
                                        </div>
                                        <div class="row mb-4">
                                            <div class="col-6 text-left">Total:</div>
                                            <div class="col-6 text-right"><strong>Rp{{ totalSum }}</strong></div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="modalBtn" data-dismiss="modal">Continue Shopping</button>
                                        <button id='checkOutBtn' type="button" class="modalBtn isLogIn" data-dismiss="modal" v-on:click="checkOut()">Check Out</button>
                                        <button id='cantCheckOutBtn' type="button" class="isLogOut">You should log in to check out</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                    
                <nav class="navbar navbar-expand-lg navbar-dark bg-danger col-12">
                    <div class="container-fluid pl-4">
                        <button class="navbar-toggler mx-auto" type="button" data-toggle="collapse" data-target="#theNavbar">
                            <span class="navbar-toggler-icon"></span>
                        </button>
            
                        <div class="collapse navbar-collapse" id="theNavbar">
                            <div id='app2' class="mx-auto">
                                <ul class="navbar-nav" style="font-size: 20px">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#app1" onclick="showAll()">All Products</a>
                                    </li>
                                    <li class="nav-tem" v-for="category in categories">
                                        <a class="nav-link" href="#app1" v-on:click="showByCategory(category.name)">{{ category.name }} Products</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        <div class="container-fluid" >
            <div id="carousel" class="carousel slide mx-auto" data-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img class="d-block w-100" src="https://via.placeholder.com/1000x500" alt="First slide">
                    </div>
                    <div class="carousel-item">
                        <img class="d-block w-100" src="https://via.placeholder.com/1000x500" alt="Second slide">
                    </div>
                    <div class="carousel-item">
                        <img class="d-block w-100" src="https://via.placeholder.com/1000x500" alt="Third slide">
                    </div>
                </div>
                <a class="carousel-control-prev" href="#carousel" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carousel" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>  
        <div class='container-fluid mt-4'>
            <div id="app1">
                <div class="text-center text-md-left my-sm-2" style="font-size: 20px; padding-left: 2.5vw">{{ title }}</div>
                    <div class="row no-gutters">
                        <div class="card col-6 col-md-4 col-lg-3 col-xl-2" v-for="product in products">
                            <img class="card-img-top" src="https://via.placeholder.com/300x300" alt="Product Image">
                            <div class="card-body">
                                <h5 class="card-title"> {{ product.name }} </h5>
                                <p class="card-text">Price: Rp{{ product.price }}</p>
                                <button class="btn btn-danger" v-on:click="addToCart(product.name, product.price)">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            var app1 = new Vue ({
                el: '#app1',
                data: {
                    title: '',
                    products: [{}]
                },
                methods: {
                    addToCart: function (name, price) {
                        let i = app3.items.indexOf(name)
                        if (i === -1) {
                            app3.items.push(name)
                            app3.cart.push({
                                name: name,
                                price: price,
                                count: 1,
                                total: price
                            })
                            app3.totalSum += price
                        } else {
                            app3.cart[i].count ++
                            app3.cart[i].total += price
                            app3.totalSum += price
                        }
                        
                        localStorage.setItem('items', JSON.stringify(app3.items))
                        localStorage.setItem('cart', JSON.stringify(app3.cart))
                        localStorage.setItem('totalSum', app3.totalSum)

                        $('#cartLogo').css('color', 'red')

                        if (localStorage.getItem('jwtToken')) {
                            $('#checkOutBtn').show()
                        } else {
                            $('#cantCheckOutBtn').show()
                        }
                    }
                }
            })

            var app2 = new Vue ({
                el: '#app2',
                data: {
                    categories: [{}]
                },
                methods: {
                    showByCategory: function(category) {
                        $.ajax({
                            type: 'POST',
                            url: 'http://localhost:3000/products/sbc',
                            data: {category: category}
                        })
                        .then(result => {
                            app1.title = `${category} Products`
                            app1.products = result.data
                        })
                        .catch(err => {
                            console.log(err)
                        })
                    }
                }
            })

            var app3 = new Vue ({
                el: '#app3',
                data: {
                    items: [],
                    cart: [],
                    totalSum: 0
                },
                methods: {
                    removeFromCart: function (name, price) {
                        let i = this.items.indexOf(name)
                        this.cart[i].count --
                        this.cart[i].total -= price
                        this.totalSum -= price
                        
                        if (this.cart[i].count === 0) {
                            this.items.splice(i, 1)
                            this.cart.splice(i, 1)
                        }
                        
                        localStorage.setItem('items', JSON.stringify(app3.items))
                        localStorage.setItem('cart', JSON.stringify(app3.cart))
                        localStorage.setItem('totalSum', app3.totalSum)

                        if (this.items.length === 0) {
                            $('#cartLogo').css('color', 'grey')

                            if (localStorage.getItem('jwtToken')) {
                                $('#checkOutBtn').hide()
                            } else {
                                $('#cantCheckOutBtn').hide()
                            }
                        }
                    },

                    checkOut: function () {
                        this.items = [],
                        this.cart = [],
                        this.totalSum = 0

                        localStorage.removeItem('items')
                        localStorage.removeItem('cart')
                        localStorage.removeItem('totalSum')

                        $('#cartLogo').css('color', 'grey')
                        $('#checkOutBtn').hide()
                    }
                }
            })

            var app4 = new Vue ({
                el: '#app4',
                data: {
                    notice: '',
                    title: ''
                }
            })
            
            showAll()
            showNav()

            function showNav() {
                $.ajax({
                    url: 'http://localhost:3000/categories'
                })
                .then(result => {
                    app2.categories = result.data
                })
                .catch(err => {
                    console.log(err)
                })
            }

            function showAll() {
                $.ajax({
                    url: 'http://localhost:3000/products'
                })
                .then(result => {
                    app1.title = 'All Products'
                    app1.products = result.data
                })
                .catch(err => {
                    console.log(err)
                })
            }

            function checkLoginState() {
                FB.getLoginStatus(function(response) {
                retrieveInfo(response);
                });
            }
            
            function retrieveInfo(response) {
                let token = response.authResponse.accessToken
                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:3000/users/loginfb',
                    data: {accessToken: token}
                })
                .then(data => {
                    localStorage.setItem('jwtToken', data.token)
                    showLogOut()
                })
                .catch(err => {
                    console.log(err)
                })
            }

            function logIn() {
                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:3000/users/login',
                    data: {email: $('#email').val(), password: $('#password').val()}
                })
                .then(data => {
                    localStorage.setItem('jwtToken', data.token)
                    app4.notice = ''
                    showLogOut()
                })
                .catch(err => {
                    app4.notice = err.responseJSON.message
                })
            }

            function register() {
                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:3000/users/register',
                    data: {email: $('#email').val(), password: $('#password').val()}
                })
                .then(data => {
                    localStorage.setItem('jwtToken', data.token)
                    app4.notice = ''
                    showLogOut()
                })
                .catch(err => {
                    app4.notice = err.responseJSON.message
                })
            }
            
            if (localStorage.getItem('jwtToken')) {
                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:3000/users/checklocalstorage',
                    data: {jwtToken: localStorage.getItem('jwtToken')}
                })
                .then(data => {
                    if (data.isLogin) {
                        showLogOut()
                    } else {
                        showLogIn()
                    }
                    })
                .catch(err => {
                console.log(err)
                })
            } else {
                showLogIn()
            }

            function showLogOut() {
                $('#logLaterBtn').click()

                $('.isLogIn').show()
                $('.isLogOut').hide()
                app4.title = 'Log Out'
                
                if (localStorage.getItem('items')) {
                    app3.items = JSON.parse(localStorage.getItem('items'))
                }
                
                if (localStorage.getItem('cart')) {
                    app3.cart = JSON.parse(localStorage.getItem('cart'))
                }
                
                if (localStorage.getItem('totalSum')) {
                    app3.totalSum = Number(localStorage.getItem('totalSum'))
                }
                

                if (app3.items.length === 0) {
                    $('#checkOutBtn').hide()
                } else {
                    $('#cartLogo').css('color', 'red')
                }
            }

            function showLogIn() {
                $('.isLogIn').hide()
                $('.isLogOut').show()
                $('#cantCheckOutBtn').hide()
                app4.title = 'Log In'
            }
            
            function logOut() {
                localStorage.clear()
                app3.checkOut()
                showLogIn()
            }
        </script>
        
    </body>
</html>